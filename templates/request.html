{{define "content"}}
<body>
    <div class="form-container">

        {{if eq .Request.Status 2}}
            <h2>Просмотр закрытой заявки</h2>
        {{else}}
            <h2>Редактирование заявки</h2>
        {{end}}

        {{if eq .IsAdmin 1}}
            <div class="top-buttons">
                <form action="/request/{{.Request.Id}}/addDocument" method="GET" onsubmit="return confirm('Добавить файл к заявке?\n\nНесохраненные изменения будут сброшены');">
                    <button type="submit" class="btn">Добавить файл</button>
                </form>
                {{if ne .Request.Status 2}}
                    <a href="/request/{{.Request.Id}}/close" class="btn">Закрыть заявку</a>
                {{end}}
                {{if eq .Request.Status 2}}
                    <a href="/request/{{.Request.Id}}/report" class="btn">Сформировать акт</a>
                {{end}}
            </div>
        {{end}}

        {{if .Documents}}
            <div class="attached-files">
                <h3>Прикрепленные файлы</h3>
                <ul class="file-list">
                    {{range .Documents}}
                    <li class="file-item">
                        <form action="/document/{{.Id}}/delete" method="POST" class="delete-form" onsubmit="return confirm('Удалить файл {{.Name}}?');">
                            <button type="submit" class="btn btn-danger btn-small">✖</button>
                        </form>
                        <a href="/document/{{.Id}}" target="_blank" class="file-link">
                            {{.Type}} (Добавлен {{.AddDate}}) — {{.UserLogin}}
                        </a>
                    </li>

                    {{end}}
                </ul>
            </div>

        {{end}}

        {{if eq .Request.Status 2}}
            <!-- Только просмотр, без формы -->
            <div class="form-group">
                <label>ID</label>
                <input type="text" value="{{.Request.Id}}" readonly class="readonly">
            </div>

            <div class="form-group">
                <label>Тип</label>
                {{range .Types}}
                    {{if eq $.Request.Type .Id}}
                        <input type="text" value="{{.Name}}" readonly class="readonly">
                    {{end}}
                {{end}}
            </div>

            <div class="form-group">
                <label>Описание</label>
                <textarea readonly class="readonly">{{.Request.Description}}</textarea>
            </div>

            <div class="form-group">
                <label>Автор</label>
                <input type="text" value="{{.Author.Login}} - {{.Author.Name}}" readonly class="readonly">
            </div>

            <div class="form-group">
                <label>Статус</label>
                <input type="text" value="Закрыта" readonly class="readonly">
            </div>

            <div class="form-group">
                <label>Создана</label>
                <input type="text" value="{{.Request.CreatedAt}}" readonly class="readonly">
            </div>

            <div class="form-group">
                <label>Закрыта</label>
                <input type="text" value="{{.Request.ClosedAt}}" readonly class="readonly">
            </div>

            <div class="form-group">
                <label>Оборудование</label>
                {{range .AllEquipment}}
                    {{if eq $.Request.Equipment .Id}}
                        <input type="text" value="{{.Directory}} / {{.Department}} / ( {{.InvNum}} )" readonly class="readonly">
                    {{end}}
                {{end}}
            </div>

            <div class="form-group">
                <label>Результат заявки</label>
                {{range .Results}}
                    {{if eq $.Request.Result .Id}}
                        <input type="text" value="{{.Name}}" readonly class="readonly">
                    {{end}}
                {{end}}
            </div>

            <div class="form-group">
                <label>Описание результата заявки</label>
                <textarea readonly class="readonly">{{.Request.ResultDescr}}</textarea>
            </div>

        {{else}}
            <!-- Редактируемая форма -->
            <form action="/request/{{.Request.Id}}" method="POST">
                <div class="form-group">
                    <label>ID</label>
                    <input type="text" value="{{.Request.Id}}" readonly class="readonly">
                </div>

                <div class="form-group">
                    <label>Тип</label>
                    {{if eq .IsAdmin 1}}
                        <select name="type">
                            {{range .Types}}
                                <option value="{{.Id}}" {{if eq $.Request.Type .Id}}selected{{end}}>{{.Name}}</option>
                            {{end}}
                        </select>
                    {{else}}
                        {{range .Types}}
                            {{if eq $.Request.Type .Id}}
                                <input type="text" value="{{.Name}}" readonly class="readonly">
                            {{end}}
                        {{end}}
                    {{end}}
                </div>

                <div class="form-group">
                    <label>Описание</label>
                    <textarea name="description">{{.Request.Description}}</textarea>
                </div>

                <div class="form-group">
                    <label>Автор</label>
                    <input type="text" value="{{.Author.Login}} - {{.Author.Name}}" readonly class="readonly">
                </div>

                <div class="form-group">
                    <label>Статус</label>
                    <input type="text" value="Открыта" readonly class="readonly">
                </div>

                <div class="form-group">
                    <label>Создана</label>
                    <input type="text" value="{{.Request.CreatedAt}}" readonly class="readonly">
                </div>


                {{if eq .Request.Status 2}}
                    <div class="form-group">
                        <label>Закрыта</label>
                        {{if eq .IsAdmin 1}}
                            <input type="text" name="closed" value="{{.Request.ClosedAt}}">
                        {{else}}
                            <input type="text" value="{{.Request.ClosedAt}}" readonly class="readonly">
                        {{end}}
                    </div>
                {{end}}

                <div class="form-group">
                    <label>Оборудование</label>
                    {{if eq .IsAdmin 1}}
                        <select name="equipment">
                            {{range .AllEquipment}}
                                <option value="{{.Id}}" {{if eq $.Request.Equipment .Id}}selected{{end}}>{{.Directory}} / {{.Department}} / ( {{.InvNum}} )</option>
                            {{end}}
                        </select>
                    {{else}}
                        {{range .AllEquipment}}
                            {{if eq $.Request.Equipment .Id}}
                                <input type="text" value="{{.Directory}} / {{.Department}} ( {{.InvNum}} )" readonly class="readonly">
                            {{end}}
                        {{end}}
                    {{end}}
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn">Сохранить</button>
                    <a href="/allactive" class="btn btn-secondary">Отмена</a>
                </div>
            </form>
        {{end}}
    </div>
</body>
{{end}}
